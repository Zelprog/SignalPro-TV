//@version=5
indicator("SignalPro v1.0.0", shorttitle="SP v1.0", overlay=true, max_labels_count=500)

// ============================================================================
// SIGNALPRO v1.0.0-rc3 - Indicateur TradingView 
// Signaux crypto robustes : Trend Filter + Breakout + Pullback + ATR Risk
// Repository: https://github.com/Zelprog/SignalPro-TV
// ============================================================================

// === INPUTS CONFIGURATION ===
// Filtre de R√©gime
ema200_len = input.int(200, "EMA200 Length", minval=50, maxval=500, group="üéØ Filtre R√©gime")
st_len = input.int(10, "Supertrend ATR Length", minval=5, maxval=20, group="üéØ Filtre R√©gime") 
st_mult = input.float(3.0, "Supertrend Multiplier", minval=1.0, maxval=10.0, step=0.1, group="üéØ Filtre R√©gime")
use_adx_filter = input.bool(true, "Utiliser filtre ADX", group="üéØ Filtre R√©gime")
adx_len = input.int(14, "ADX Length", minval=10, maxval=30, group="üéØ Filtre R√©gime")
adx_threshold = input.float(25.0, "ADX Seuil minimum", minval=15.0, maxval=40.0, step=1.0, group="üéØ Filtre R√©gime")

// Entr√©es Signaux
enable_breakout = input.bool(true, "Activer Breakout Donchian", group="üìà Entr√©es")
donchian_len = input.int(20, "Donchian Channel Length", minval=10, maxval=50, group="üìà Entr√©es")
atr_filter_len = input.int(14, "ATR Filter Length", minval=10, maxval=30, group="üìà Entr√©es")
atr_percentile = input.float(60.0, "ATR Percentile minimum (%)", minval=40.0, maxval=80.0, step=5.0, group="üìà Entr√©es")
breakout_strength_min = input.float(0.1, "Breakout Strength Min", minval=0.05, maxval=0.5, step=0.05, group="üìà Entr√©es")

enable_pullback = input.bool(true, "Activer Pullback", group="üìà Entr√©es")
ema20_len = input.int(20, "EMA Pullback Length", minval=10, maxval=50, group="üìà Entr√©es")
rsi_len = input.int(14, "RSI Length", minval=10, maxval=21, group="üìà Entr√©es")
rsi_oversold = input.float(40.0, "RSI Seuil survente", minval=20.0, maxval=50.0, step=5.0, group="üìà Entr√©es")
rsi_overbought = input.float(60.0, "RSI Seuil surachat", minval=50.0, maxval=80.0, step=5.0, group="üìà Entr√©es")

// Gestion Risque
atr_len = input.int(14, "ATR Length", minval=10, maxval=30, group="üõ°Ô∏è Gestion Risque")
atr_sl_mult = input.float(2.0, "ATR Stop Loss Multiplier", minval=1.0, maxval=5.0, step=0.1, group="üõ°Ô∏è Gestion Risque")
tp_r_mult1 = input.float(1.5, "Take Profit 1 (R multiple)", minval=0.5, maxval=5.0, step=0.1, group="üõ°Ô∏è Gestion Risque")

// Affichage
show_levels = input.bool(true, "Afficher niveaux SL/TP", group="üëÅÔ∏è Affichage")
show_stats_table = input.bool(true, "Afficher table stats", group="üëÅÔ∏è Affichage")

// === CALCULS INDICATEURS TECHNIQUES ===
// Moyennes mobiles et tendance
ema200 = ta.ema(close, ema200_len)
ema20 = ta.ema(close, ema20_len)
atr = ta.atr(atr_len)

// Supertrend
[st_trend, st_line] = ta.supertrend(st_mult, st_len)
st_bull = st_trend == 1
st_bear = st_trend == -1

// RSI
rsi = ta.rsi(close, rsi_len)

// ADX
[di_plus, di_minus, adx] = ta.dmi(adx_len, adx_len)

// Donchian Channels
donchian_high = ta.highest(high, donchian_len)
donchian_low = ta.lowest(low, donchian_len)
donchian_mid = (donchian_high + donchian_low) / 2

// === FILTRE DE R√âGIME ===
// Condition de r√©gime haussier
regime_bull = close > ema200 and st_bull
regime_bear = close < ema200 and st_bear
regime_neutral = not regime_bull and not regime_bear

// Filtre ADX optionnel
adx_ok = not use_adx_filter or adx > adx_threshold

// === LOGIQUE SIGNAUX (AM√âLIOR√âE v1.0.0) ===
// Filtre volatilit√© ATR pour breakouts
atr_filter = ta.atr(atr_filter_len)
atr_percentile_rank = ta.percentrank(atr_filter, 100)
atr_volatility_ok = atr_percentile_rank >= atr_percentile

// Breakout Donchian - Logique raffin√©e
donchian_range = donchian_high - donchian_low
breakout_strength_long = donchian_range > 0 ? (close - donchian_high[1]) / donchian_range : 0
breakout_strength_short = donchian_range > 0 ? (donchian_low[1] - close) / donchian_range : 0

// Conditions breakout (une seule ligne pour compatibilit√© Pine)
breakout_long = enable_breakout and regime_bull and adx_ok and close > donchian_high[1] and atr_volatility_ok and breakout_strength_long >= breakout_strength_min

breakout_short = enable_breakout and regime_bear and adx_ok and close < donchian_low[1] and atr_volatility_ok and breakout_strength_short >= breakout_strength_min

// Pullback - Logique am√©lior√©e (RSI cross-over)
was_oversold = rsi[1] < rsi_oversold and rsi > rsi_oversold // Sortie survente
was_overbought = rsi[1] > rsi_overbought and rsi < rsi_overbought // Sortie surachat
rsi_cross_up = ta.crossover(rsi, 50)
rsi_cross_down = ta.crossunder(rsi, 50)
ema_pullback_bull = close > ema20 and close[1] <= ema20
ema_pullback_bear = close < ema20 and close[1] >= ema20

// Conditions pullback (une seule ligne pour compatibilit√© Pine)
pullback_long = enable_pullback and regime_bull and adx_ok and (was_oversold or rsi_cross_up) and ema_pullback_bull

pullback_short = enable_pullback and regime_bear and adx_ok and (was_overbought or rsi_cross_down) and ema_pullback_bear

// Signaux combin√©s
signal_long = breakout_long or pullback_long
signal_short = breakout_short or pullback_short

// === GESTION POSITIONS (CORRECTION v1.0.0-rc3) ===
// Variables pour tracking position
var float entry_price = na
var float stop_loss = na  
var float take_profit1 = na
var bool in_position = false

// Calcul niveaux (quand signal)
sl_distance = atr * atr_sl_mult
tp1_distance = sl_distance * tp_r_mult1

if signal_long and not in_position
    entry_price := close
    stop_loss := entry_price - sl_distance
    take_profit1 := entry_price + tp1_distance
    in_position := true

if signal_short and not in_position  
    entry_price := close
    stop_loss := entry_price + sl_distance
    take_profit1 := entry_price - tp1_distance
    in_position := true

// === GESTION SORTIES (CORRECTION URGENTE) ===
// Conditions de sortie simples pour d√©bloquer les indicateurs
exit_long_sl = in_position and close <= stop_loss
exit_long_tp = in_position and close >= take_profit1
exit_short_sl = in_position and close >= stop_loss  
exit_short_tp = in_position and close <= take_profit1

// Sortie de position (reset des variables)
exit_position = exit_long_sl or exit_long_tp or exit_short_sl or exit_short_tp

if exit_position
    in_position := false
    entry_price := na
    stop_loss := na
    take_profit1 := na

// === PLOTS ET AFFICHAGE ===
// Moyennes mobiles
plot(ema200, "EMA200", color=color.blue, linewidth=2)
plot(ema20, "EMA20", color=color.orange, linewidth=1)

// Supertrend
plot(st_line, "Supertrend", color=st_bull ? color.green : color.red, linewidth=2)

// Donchian Channels
plot(donchian_high, "Donchian High", color=color.gray, style=plot.style_line)
plot(donchian_low, "Donchian Low", color=color.gray, style=plot.style_line)
plot(donchian_mid, "Donchian Mid", color=color.gray, style=plot.style_line, linewidth=1)

// Signaux d'entr√©e
plotshape(signal_long, style=shape.triangleup, location=location.belowbar, color=color.green, size=size.normal, title="BUY ENTRY")
plotshape(signal_short, style=shape.triangledown, location=location.abovebar, color=color.red, size=size.normal, title="SELL ENTRY")

// Signaux de sortie (nouveaux)
plotshape(exit_long_sl, style=shape.xcross, location=location.abovebar, color=color.red, size=size.small, title="EXIT STOP LOSS")
plotshape(exit_long_tp, style=shape.diamond, location=location.abovebar, color=color.lime, size=size.small, title="EXIT TAKE PROFIT")
plotshape(exit_short_sl, style=shape.xcross, location=location.belowbar, color=color.red, size=size.small, title="EXIT STOP LOSS")
plotshape(exit_short_tp, style=shape.diamond, location=location.belowbar, color=color.lime, size=size.small, title="EXIT TAKE PROFIT")

// Niveaux SL/TP
plot(show_levels and not na(stop_loss) ? stop_loss : na, "Stop Loss", color=color.red, style=plot.style_cross, linewidth=1)
plot(show_levels and not na(take_profit1) ? take_profit1 : na, "Take Profit 1", color=color.green, style=plot.style_cross, linewidth=1)

// === TABLE STATISTIQUES (PLACEHOLDER) ===
if show_stats_table and barstate.islast
    var table stats_table = table.new(position.top_right, 2, 8, bgcolor=color.white, border_width=1)
    table.cell(stats_table, 0, 0, "SignalPro", text_color=color.black, text_size=size.normal)
    table.cell(stats_table, 1, 0, "v1.0.0-rc3", text_color=color.gray, text_size=size.small)
    table.cell(stats_table, 0, 1, "R√©gime", text_color=color.black)
    table.cell(stats_table, 1, 1, regime_bull ? "BULL" : regime_bear ? "BEAR" : "NEUTRAL", text_color=regime_bull ? color.green : regime_bear ? color.red : color.gray)
    table.cell(stats_table, 0, 2, "ADX", text_color=color.black)
    table.cell(stats_table, 1, 2, str.tostring(math.round(adx, 1)), text_color=color.black)
    table.cell(stats_table, 0, 3, "ATR", text_color=color.black)
    table.cell(stats_table, 1, 3, str.tostring(math.round(atr, 4)), text_color=color.black)
    table.cell(stats_table, 0, 4, "RSI", text_color=color.black)  
    table.cell(stats_table, 1, 4, str.tostring(math.round(rsi, 1)), text_color=color.black)
    table.cell(stats_table, 0, 5, "Position", text_color=color.black)
    table.cell(stats_table, 1, 5, in_position ? "ACTIVE" : "FLAT", text_color=in_position ? color.blue : color.gray)
    table.cell(stats_table, 0, 6, "GitHub", text_color=color.black)
    table.cell(stats_table, 1, 6, "SignalPro-TV", text_color=color.blue, text_size=size.small)

// === ALERTES ===
// Alertes pour int√©gration future webhook
alertcondition(signal_long, title="SIGNAL LONG", message='{"v":"1.0.0","side":"BUY","symbol":"{{ticker}}","price":"{{close}}","timeframe":"{{interval}}","note":"SignalPro"}')
              
alertcondition(signal_short, title="SIGNAL SHORT", message='{"v":"1.0.0","side":"SELL","symbol":"{{ticker}}","price":"{{close}}","timeframe":"{{interval}}","note":"SignalPro"}')

// ============================================================================
// VERSION : 1.0.0-rc3
// STATUS : Gestion position compl√®te - Entr√©es + Sorties SL/TP + Signaux visuels
// TODO : Trailing stop ATR, backtest embarqu√©, validation multi-timeframes
// ============================================================================
